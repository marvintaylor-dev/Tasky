@using System.Reflection
@using Tasky.Client.Services
@using static Tasky.Shared.NoteModel
@inject IJSRuntime JS
@inject IMemberService memberService;
@inject ITaskService taskService;


<div class="subTaskContainer">
    <div class="d-flex gap-5">
        <div class="d-flex">
        @if (IsClicked || !IsClicked && SubTask.TaskId == 0)
        {
            <input type="text" id="taskInput" placeholder="Enter Task Name" autofocus=true
               @onfocus="@Clicked"
               @onkeydown="@Enter"
               @bind-value="SubTask.Name"
               @bind-value:event="oninput" />
        }
        else if (!IsClicked)
        {
            <div @onclick="toggleIsClicked">@SubTask.Name</div>
        }
    </div>
    <div>

        <span>Move to:</span>
        <select 
            @bind-value="SubTask.LinkTo" 
            @bind-value:event="onchange" 
            @onfocus="@Clicked">
            @foreach (var task in tasks)
            {
                if (task.isSubTask == false)
                {
                    <option @onkeydown="@Enter" value="@task.TaskId">@task.Name</option>
                }
                else
                {
                    <select>
                        <option>No Options</option>
                    </select>
                }
            }
        </select>
    </div>
    </div>
    

    <div class="taskInfoContainer">
        @if (members.Count > 0)
        {
            <select @bind-value="SubTask.Assignee" @bind-value:event="onchange" @onfocus="@Clicked">
                @foreach (var member in members)
                {
                    <option @onkeydown="@Enter" value="@member.MemberId">@member.Name</option>
                }
            </select>
        }
        else
        {
            <select>
                <option>No Options</option>
            </select>
        }

        <select @bind-value="SubTask.PriorityLevel" @bind-value:event="onchange" @onfocus="@Clicked">
            @foreach (var priority in Enum.GetValues(typeof(Priority)))
            {
                <option>@priority</option>
            }
        </select>

        <select @bind-value="SubTask.status" @bind-value:event="onchange" @onfocus="@Clicked">
            @foreach (var status in Enum.GetValues(typeof(Status)))
            {
                <option>@status</option>
            }
        </select>
        <input type="date" placeholder="Due Date" @bind-value="SubTask.DueDate" @bind-value:event="onchange" @onfocus="@Clicked" />
        @if (SubTask.TaskId > 0)
        {
            <button @onclick="(()=> DeleteSubTask(SubTask.TaskId))">X</button>
        }
        else
        {
            <button @onclick="(()=> DeleteUnsavedSubTask())">X</button>
        }

        @if (SubTask.Name != String.Empty && IsClicked && SubTask.TaskId > 0)
        {
            <button id="editButton" @onclick="(()=> EditTask(SubTask))">Edit</button>
        }
        else if (SubTask.Name != String.Empty && IsClicked)
        {
            <button id="saveButton" @onclick="(() => SaveTask(SubTask))">Save</button>
        }
    </div>
</div>



@code {
    public List<Member> members = new List<Member>();
    public List<NoteModel> tasks = new List<NoteModel>();
    public NoteModel newSubTask = new NoteModel();


    [Parameter]
    public NoteModel SubTask { get; set; }

    [Parameter]
    public EventCallback RefreshSubTasks { get; set; }

    [Parameter]
    public EventCallback CallSubTask { get; set; }




    PropertyInfo[]? properties;


    protected override async Task OnParametersSetAsync()
    {
        await GetMembers();
        tasks = await taskService.GetTasks();



        Type type = typeof(NoteModel);
        properties = type.GetProperties();

        await base.OnParametersSetAsync();
    }


    public async Task GetMembers()
    {
        members = await memberService.GetMembers();
    }


    //onclick for each task descriptor assignee, priority, status, due date
    //when clicked. Turn into an input which listens for input. Bring up save button when an input is available


    public bool IsClicked = false;


    async void SaveTask(NoteModel task)
    {
        await taskService.AddTask(task);
        UnClick();
        await RefreshSubTasks.InvokeAsync();
    }

    async void DeleteSubTask(int id)
    {
        await taskService.DeleteTask(id);
        await RefreshSubTasks.InvokeAsync();
    }

    async void EditTask(NoteModel task)
    {
        await taskService.UpdateTask(task);
        UnClick();
        await RefreshSubTasks.InvokeAsync();
    }

    async void DeleteUnsavedSubTask()
    {
        tasks.Remove(SubTask);
        await RefreshSubTasks.InvokeAsync();
    }

    void UnClick()
    {
        IsClicked = false;
    }

    void Clicked()
    {
        IsClicked = true;
    }

    void toggleIsClicked()
    {
        IsClicked = !IsClicked;
    }

    public void Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            ClickSaveBtn();
        }
    }

    public void EnterOnSelect(EventArgs e)
    {
        ClickSaveBtn();
    }

    public async void ClickSaveBtn()
    {
        try
        {
            await JS.InvokeVoidAsync("saveOnEnter");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
    }
}
