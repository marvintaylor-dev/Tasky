@page "/list"
@page "/list/{Id}"
@using Tasky.Shared.DTOs;

@inject IJSRuntime JS
@inject ITaskService taskService
@inject IMemberService memberService
@attribute [Authorize]



<div class="titleContainer d-flex justify-content-center align-items-center flex-column">
    <h3>Assignee List</h3>

    <select @bind-value="Id" @bind-value:event="onchange">
        <option default value="0">Show All</option>
        @foreach (var member in memberService.Members)
        {
            <option value="@member.MemberId">@member.Name</option>
            
        }
    </select>
</div>

@if (isLoading)
{
    <LoadingIndicatorComponent />
}

@if (Id > 0)
{
    <div class="centerTask">
        @foreach (var member in memberService.Members)
        {
            if (member.MemberId == Id)
            {
                <div class="d-flex align-content-center align-items-center gap-3">
                    <h4 class="mt-3">@member.Name</h4>
                    <MudIconButton Icon="@Icons.Material.Filled.Add"
                       Style="margin-top: none;"
                       Variant="Variant.Outlined"
                       Color="Color.Transparent"
                       Size="Size.Small" @onclick="(() => AddNewTask(member.MemberId))" />
                </div>
                @foreach (NoteModel task in tasks)
                {
                    if (task.Assignee == member.MemberId)
                    {
                        <TaskComponent Task="task" RefreshList="RefreshList"></TaskComponent>
                    }
                    else if (task.TaskId == 0 && task.Assignee == member.MemberId)
                    {
                        <TaskComponent Task="task" RefreshList="RefreshList"></TaskComponent>
                    }
                }
                
            }
        }
    </div>
}

@if (Id == 0)
{
    <div class="centerTask">
        @foreach (var member in memberService.Members)
        {
            <div class="d-flex align-content-center align-items-center gap-3">
                <h4 class="mt-3">@member.Name</h4>
                <MudIconButton Icon="@Icons.Material.Filled.Add"
                       Style="margin-top: none;"
                       Variant="Variant.Outlined"
                       Color="Color.Transparent"
                       Size="Size.Small" @onclick="(() => AddNewTask(member.MemberId))" />
            </div>
            @foreach (NoteModel task in tasks)
            {
                if (task.Assignee == member.MemberId)
                {
                    <TaskComponent Task="task" RefreshList="RefreshList"></TaskComponent>
                }
                else if (task.TaskId == 0 && task.Assignee == member.MemberId)
                {
                    <TaskComponent Task="task" RefreshList="RefreshList"></TaskComponent>
                }
            }
         
        }
    </div>
}

<div class="centerTask mt-5">
    <h3>Unassigned Tasks</h3>
    @foreach (NoteModel task in tasks)
    {
        if (task.Assignee == 0 && task.isSubTask == false)
        {
            <TaskComponent Task="task" RefreshList="RefreshList"></TaskComponent>
        }
        if (task.isSubTask == true && task.Assignee == 0)
        {
            NoteModel isTaskAvailable = tasks.FirstOrDefault(t => t.TaskId == task.LinkTo);
            if (isTaskAvailable == null)
            {
                <TaskComponent Task="task" RefreshList="RefreshList"></TaskComponent>
            }
            else
            {
                Console.WriteLine(isTaskAvailable);
            }
        }
    }
    <MudFab Color="Color.Info" Style="margin-top: 2rem;" StartIcon="@Icons.Material.Filled.Add" Size="Size.Medium" @onclick="AddNewTask" />
</div>



@code {
    private bool isLoading = true;

    [Parameter]
    public int Id { get; set; }

    NoteModel newTask = new NoteModel();
    List<NoteModel> tasks = new List<NoteModel>();
    MemberDTO memberId = new MemberDTO();

    protected override async Task OnInitializedAsync()
    {
        tasks = await taskService.GetTasks();
        await memberService.GetMembers();
        isLoading = false;
        await base.OnInitializedAsync();
    }


    void AddNewTask(int id)
    {
        tasks.Add(newTask);
        newTask.Name = String.Empty;
        memberId = memberService.Members.FirstOrDefault(m => m.MemberId == id);
        newTask.Assignee = memberId.MemberId;
        StateHasChanged();
    }

    void AddNewTask()
    {
        tasks.Add(newTask);
        newTask.Name = String.Empty;
        StateHasChanged();
    }

    public async Task RefreshList()
    {
        isLoading = true;
        tasks = await taskService.GetTasks();
        isLoading = false;
        StateHasChanged();
        Console.WriteLine("RefreshList Has Been Called");
    }

    public async void RefreshSubTasks()
    {
        isLoading = true;
        tasks = await taskService.GetTasks();
        isLoading = false;
        StateHasChanged();
        Console.WriteLine("Refresh SubTasks Has Been Called");
    }
}
